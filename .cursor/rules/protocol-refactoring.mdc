---
description: –ü—Ä–æ—Ç–æ–∫–æ–ª –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ ‚Äî —É–ª—É—á—à–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ–≤–µ–¥–µ–Ω–∏—è
alwaysApply: false
---
# üîß PROTOCOL: REFACTORING

> **–ê–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è —á–µ—Ä–µ–∑:** `core-master.mdc` –ø—Ä–∏ —É–ª—É—á—à–µ–Ω–∏–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∫–æ–¥–∞
> **–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞:** —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥, —É–ª—É—á—à–∏—Ç—å –∫–æ–¥, –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å, —É–ø—Ä–æ—Å—Ç–∏—Ç—å, –æ—á–∏—Å—Ç–∏—Ç—å
> **–ë–∞–∑–æ–≤—ã–µ –º–æ–¥—É–ª–∏:** `_base-confidence.mdc`, `_base-challenge.mdc`, `standard-qa.mdc`

---

## Core Principle: CHANGE STRUCTURE, NOT BEHAVIOR

```
Refactoring = –£–ª—É—á—à–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∫–æ–¥–∞
              –ë–ï–ó –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤–Ω–µ—à–Ω–µ–≥–æ –ø–æ–≤–µ–¥–µ–Ω–∏—è

–ï—Å–ª–∏ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –º–µ–Ω—è–µ—Ç—Å—è ‚Üí —ç—Ç–æ NOT refactoring, —ç—Ç–æ feature/bugfix
```

---

## 1. WHEN TO REFACTOR

### ‚úÖ Refactor When:
- [ ] –ö–æ–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ —Ç—Ä—É–¥–Ω–æ –ø–æ–Ω—è—Ç—å
- [ ] –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥ (DRY violation)
- [ ] –î–ª–∏–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã (> 50 —Å—Ç—Ä–æ–∫)
- [ ] –ì–ª—É–±–æ–∫–∞—è –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç—å (> 3 levels)
- [ ] –°–ª–æ–∂–Ω—ã–µ —É—Å–ª–æ–≤–∏—è
- [ ] –ü–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –Ω–æ–≤–æ–π —Ñ–∏—á–∏ –≤ messy code
- [ ] –ü–æ—Å–ª–µ —Ç–æ–≥–æ –∫–∞–∫ —Ç–µ—Å—Ç—ã –∑–µ–ª—ë–Ω—ã–µ

### ‚ùå Do NOT Refactor When:
- [ ] –ö–æ–¥ –µ—â—ë –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç (fix first!)
- [ ] –ù–µ—Ç —Ç–µ—Å—Ç–æ–≤ (add tests first!)
- [ ] –ü–æ–¥ –¥–∞–≤–ª–µ–Ω–∏–µ–º –≤—Ä–µ–º–µ–Ω–∏ (ship first, refactor later)
- [ ] "Just because" (–Ω—É–∂–Ω–∞ —á—ë—Ç–∫–∞—è –ø—Ä–∏—á–∏–Ω–∞)
- [ ] –í–æ –≤—Ä–µ–º—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∏—á–∏ (finish feature first)

---

## 2. REFACTORING SAFETY PROTOCOL

### –ü–µ—Ä–µ–¥ –õ–Æ–ë–´–ú —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–æ–º:

```markdown
## üîß REFACTORING PLAN

### What: [–ö–∞–∫–æ–π –∫–æ–¥ –±—É–¥–µ—Ç –∏–∑–º–µ–Ω—ë–Ω]
### Why: [–ó–∞—á–µ–º —ç—Ç–æ—Ç —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –Ω—É–∂–µ–Ω]
### Risk: [–ß—Ç–æ –º–æ–∂–µ—Ç —Å–ª–æ–º–∞—Ç—å—Å—è]

### Safety Checks:
- [ ] –¢–µ—Å—Ç—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç –∏ –ø—Ä–æ—Ö–æ–¥—è—Ç
- [ ] –ü–æ–≤–µ–¥–µ–Ω–∏–µ –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ
- [ ] –ü–ª–∞–Ω –æ—Ç–∫–∞—Ç–∞ –µ—Å—Ç—å

### Steps:
1. [–ú–∞–ª–µ–Ω—å–∫–∏–π —à–∞–≥ 1]
2. [–ú–∞–ª–µ–Ω—å–∫–∏–π —à–∞–≥ 2]
3. [–ú–∞–ª–µ–Ω—å–∫–∏–π —à–∞–≥ 3]
```

### Safety Rules:

1. **–¢–µ—Å—Ç—ã –î–û–õ–ñ–ù–´ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å** –ø–µ—Ä–µ–¥ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–æ–º
2. **–¢–µ—Å—Ç—ã –î–û–õ–ñ–ù–´ –ø—Ä–æ—Ö–æ–¥–∏—Ç—å** –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º
3. **–¢–æ–ª—å–∫–æ –º–∞–ª–µ–Ω—å–∫–∏–µ —à–∞–≥–∏** (–æ–¥–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∑–∞ —Ä–∞–∑)
4. **–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –ü–û–°–õ–ï –∫–∞–∂–¥–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è**
5. **Commit –ü–û–°–õ–ï –∫–∞–∂–¥–æ–≥–æ —É—Å–ø–µ—à–Ω–æ–≥–æ —à–∞–≥–∞**

---

## 3. REFACTORING WORKFLOW

```
1. VERIFY   ‚Üí –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç
2. IDENTIFY ‚Üí –ß—Ç–æ –Ω—É–∂–Ω–æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏—Ç—å
3. PLAN     ‚Üí –ú–∞–ª–µ–Ω—å–∫–∏–µ —à–∞–≥–∏
4. EXECUTE  ‚Üí –û–¥–∏–Ω —à–∞–≥ –∑–∞ —Ä–∞–∑
5. TEST     ‚Üí –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —à–∞–≥–∞
6. COMMIT   ‚Üí Commit –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –∑–µ–ª—ë–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞
7. REPEAT   ‚Üí –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥
```

### Workflow Checklist:

```markdown
## üîÑ REFACTORING WORKFLOW

### Step 1: Verify Starting Point
- [ ] All tests pass
- [ ] Code committed
- [ ] Branch created (optional)

### Step 2: Plan Refactoring
- [ ] Identify smell/issue
- [ ] Choose refactoring pattern
- [ ] Break into small steps

### Step 3: Execute (for each step)
- [ ] Make ONE small change
- [ ] Run tests
- [ ] If green ‚Üí commit
- [ ] If red ‚Üí revert, try smaller step

### Step 4: Verify End State
- [ ] All tests still pass
- [ ] Behavior unchanged
- [ ] Code is cleaner
```

---

## 4. COMMON REFACTORING PATTERNS

### Extract Method
```typescript
// BEFORE: Long method
function processOrder(order) {
  // 50 lines doing multiple things
}

// AFTER: Small focused methods
function processOrder(order) {
  validateOrder(order);
  const total = calculateTotal(order);
  saveOrder(order, total);
  notifyCustomer(order);
}
```

### Rename for Clarity
```typescript
// BEFORE
const d = getD();
const x = calc(d);

// AFTER
const dealData = getDealAnalytics();
const totalRevenue = calculateRevenue(dealData);
```

### Extract Variable
```typescript
// BEFORE
if (user.age > 18 && user.country === 'RU' && user.verified && !user.banned) {

// AFTER
const isAdult = user.age > 18;
const isRussian = user.country === 'RU';
const isEligible = isAdult && isRussian && user.verified && !user.banned;
if (isEligible) {
```

### Simplify Conditionals
```typescript
// BEFORE: Nested conditionals
function getDiscount(user) {
  if (user.isPremium) {
    if (user.years > 5) { return 0.3; }
    else { return 0.2; }
  } else {
    if (user.years > 5) { return 0.1; }
    else { return 0; }
  }
}

// AFTER: Guard clauses + early return
function getDiscount(user) {
  if (!user.isPremium && user.years <= 5) return 0;
  if (!user.isPremium && user.years > 5) return 0.1;
  if (user.isPremium && user.years <= 5) return 0.2;
  return 0.3;
}
```

---

## 5. CODE SMELLS TO REFACTOR

| Smell | Description | Refactoring |
|-------|-------------|-------------|
| **Long Method** | > 50 lines | Extract Method |
| **Duplicate Code** | Same code in multiple places | Extract Method/Class |
| **Long Parameter List** | > 4 parameters | Introduce Parameter Object |
| **Deep Nesting** | > 3 levels | Guard Clauses, Extract Method |
| **Magic Numbers** | Unexplained literals | Extract Constant |
| **Dead Code** | Unused code | Delete |
| **Feature Envy** | Method uses other class's data | Move Method |
| **Large Class** | Class does too much | Extract Class |

---

## 6. ANTI-PATTERNS (AVOID)

### ‚ùå Big Bang Refactoring
```
WRONG: –ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å –≤–µ—Å—å –º–æ–¥—É–ª—å –∑–∞ —Ä–∞–∑
RIGHT: –ú–∞–ª–µ–Ω—å–∫–∏–µ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å —Ç–µ—Å—Ç–∞–º–∏ –º–µ–∂–¥—É
```

### ‚ùå Refactoring Without Tests
```
WRONG: "–Ø –ø—Ä–æ—Å—Ç–æ –ø–æ—á–∏—â—É —ç—Ç–æ –±—ã—Å—Ç—Ä–µ–Ω—å–∫–æ"
RIGHT: –°–Ω–∞—á–∞–ª–∞ –Ω–∞–ø–∏—à–∏ —Ç–µ—Å—Ç—ã, –ø–æ—Ç–æ–º —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏
```

### ‚ùå Changing Behavior While Refactoring
```
WRONG: "–ü–æ–∫–∞ —è —Ç—É—Ç, —Ç–∞–∫–∂–µ –∏—Å–ø—Ä–∞–≤–ª—é —ç—Ç–æ—Ç –±–∞–≥"
RIGHT: –°–Ω–∞—á–∞–ª–∞ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥, –ø–æ—Ç–æ–º –±–∞–≥ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º commit
```

### ‚ùå Premature Abstraction
```
WRONG: –°–æ–∑–¥–∞—Ç—å –∞–±—Å—Ç—Ä–∞–∫—Ü–∏—é –¥–ª—è –∫–æ–¥–∞ –∫–æ—Ç–æ—Ä—ã–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑
RIGHT: –î–æ–∂–¥–∏—Å—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è, –ø–æ—Ç–æ–º extract
```

---

## 7. REFACTORING REPORT TEMPLATE

```markdown
## üîß REFACTORING REPORT

### Target: [File/Class/Method]
### Reason: [–ó–∞—á–µ–º —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –Ω—É–∂–µ–Ω]
### Pattern: [–ö–∞–∫–æ–π –ø–∞—Ç—Ç–µ—Ä–Ω –ø—Ä–∏–º–µ–Ω—ë–Ω]

### Before:
```[language]
// Original code
```

### After:
```[language]
// Refactored code
```

### Steps Taken:
1. [Step 1] ‚Üí Tests ‚úÖ
2. [Step 2] ‚Üí Tests ‚úÖ
3. [Step 3] ‚Üí Tests ‚úÖ

### Verification:
- [ ] All tests pass
- [ ] Behavior unchanged
- [ ] Code is cleaner
- [ ] No new warnings

### Metrics:
- Lines changed: [N]
- Complexity reduced: [before] ‚Üí [after]
- Duplication removed: [N instances]
```

---

## 8. CONFIDENCE CALIBRATION

–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–æ—Ä–º—É–ª—É –∏–∑ `_base-confidence.mdc`:

```
Base: 100%
- –ù–µ—Ç —Ç–µ—Å—Ç–æ–≤ –ø–µ—Ä–µ–¥ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–æ–º: -60%
- –ë–æ–ª—å—à–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –±–µ–∑ intermediate commits: -40%
- –ü–æ–≤–µ–¥–µ–Ω–∏–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å: -100% (—ç—Ç–æ –ù–ï —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥!)
- –ù–µ—Ç before/after comparison: -30%
```

---

## 9. GOLDEN RULES

```
1. TESTS FIRST ‚Äî –Ω–µ—Ç —Ç–µ—Å—Ç–æ–≤, –Ω–µ—Ç —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞
2. SMALL STEPS ‚Äî –æ–¥–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∑–∞ —Ä–∞–∑
3. TEST OFTEN ‚Äî –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è
4. COMMIT OFTEN ‚Äî –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –∑–µ–ª—ë–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞
5. BEHAVIOR UNCHANGED ‚Äî same inputs ‚Üí same outputs
```

### Quick Check:
```
Is it refactoring? Ask:
- Does external behavior change?
  - YES ‚Üí Not refactoring (it's a feature/fix)
  - NO ‚Üí Refactoring ‚úÖ
```

---
**–í–µ—Ä—Å–∏—è:** 1.0
**–°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏:** `_base-confidence.mdc`, `standard-qa.mdc`, `standard-tdd.mdc`
