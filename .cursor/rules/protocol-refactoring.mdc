---
description: "–ü—Ä–∏–º–µ–Ω—è—Ç—å –ø—Ä–∏ —É–ª—É—á—à–µ–Ω–∏–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∫–æ–¥–∞ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ–≤–µ–¥–µ–Ω–∏—è. –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞: —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥, —É–ª—É—á—à–∏—Ç—å –∫–æ–¥, –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å, —É–ø—Ä–æ—Å—Ç–∏—Ç—å. –¢—Ä–µ–±—É–µ—Ç: —Ç–µ—Å—Ç—ã –ü–ï–†–ï–î —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–æ–º, –º–∞–ª–µ–Ω—å–∫–∏–µ —à–∞–≥–∏, commit –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –∑–µ–ª—ë–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞."
globs: 
alwaysApply: false
tags: [refactoring, code-quality, tdd]
---

# üîß PROTOCOL: REFACTORING

## Context

- **–ö–æ–≥–¥–∞:** –£–ª—É—á—à–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∫–æ–¥–∞ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ–≤–µ–¥–µ–Ω–∏—è
- **–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞:** —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥, —É–ª—É—á—à–∏—Ç—å, –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å, —É–ø—Ä–æ—Å—Ç–∏—Ç—å
- **–ü—Ä–∏–Ω—Ü–∏–ø:** CHANGE STRUCTURE, NOT BEHAVIOR

<critical>
  –ï—Å–ª–∏ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –º–µ–Ω—è–µ—Ç—Å—è ‚Üí —ç—Ç–æ –ù–ï refactoring, —ç—Ç–æ feature/bugfix!
</critical>

---

## Requirements

### When to Refactor

| ‚úÖ Refactor When | ‚ùå Do NOT When |
|------------------|----------------|
| –ö–æ–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ —Ç—Ä—É–¥–Ω–æ –ø–æ–Ω—è—Ç—å | –ö–æ–¥ –µ—â—ë –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç |
| –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥ | –ù–µ—Ç —Ç–µ—Å—Ç–æ–≤ |
| –î–ª–∏–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã (> 50 —Å—Ç—Ä–æ–∫) | –ü–æ–¥ –¥–∞–≤–ª–µ–Ω–∏–µ–º –≤—Ä–µ–º–µ–Ω–∏ |
| –ì–ª—É–±–æ–∫–∞—è –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç—å (> 3 levels) | "Just because" |

### Safety Protocol

<required>
  1. –¢–µ—Å—Ç—ã –î–û–õ–ñ–ù–´ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å –ø–µ—Ä–µ–¥ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–æ–º
  2. –¢–µ—Å—Ç—ã –î–û–õ–ñ–ù–´ –ø—Ä–æ—Ö–æ–¥–∏—Ç—å –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º
  3. –¢–æ–ª—å–∫–æ –º–∞–ª–µ–Ω—å–∫–∏–µ —à–∞–≥–∏ (–æ–¥–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∑–∞ —Ä–∞–∑)
  4. –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –ü–û–°–õ–ï –∫–∞–∂–¥–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è
  5. Commit –ü–û–°–õ–ï –∫–∞–∂–¥–æ–≥–æ —É—Å–ø–µ—à–Ω–æ–≥–æ —à–∞–≥–∞
</required>

### Workflow

```
1. VERIFY   ‚Üí –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç
2. IDENTIFY ‚Üí –ß—Ç–æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏—Ç—å
3. PREPLAN  ‚Üí –ö–∞–∫ —Ä–µ—Ñ–∫—Ç–æ—Ä–∏—Ç—å —Å–æ–≥–ª–∞—Å–Ω–æ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ .cursor/rules/standard-file-size-limits-always.mdc
3. PLAN     ‚Üí –ú–∞–ª–µ–Ω—å–∫–∏–µ —à–∞–≥–∏
4. EXECUTE  ‚Üí –û–¥–∏–Ω —à–∞–≥
5. TEST     ‚Üí –¢–µ—Å—Ç—ã –ø–æ—Å–ª–µ —à–∞–≥–∞
6. COMMIT   ‚Üí Commit –µ—Å–ª–∏ –∑–µ–ª—ë–Ω—ã–π
7. REPEAT   ‚Üí –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥
```

### Common Patterns

| Smell | Refactoring |
|-------|-------------|
| Long Method (> 50 lines) | Extract Method |
| Duplicate Code | Extract Method/Class |
| Long Parameter List (> 4) | Parameter Object |
| Deep Nesting (> 3 levels) | Guard Clauses |
| Magic Numbers | Extract Constant |

---

## Examples

<example>
GOOD: –ú–∞–ª–µ–Ω—å–∫–∏–µ —à–∞–≥–∏ —Å —Ç–µ—Å—Ç–∞–º–∏
```markdown
### Step 1: Extract validateOrder()
- [ ] Run tests ‚Üí ‚úÖ
- [ ] Commit

### Step 2: Extract calculateTotal()
- [ ] Run tests ‚Üí ‚úÖ
- [ ] Commit

### Step 3: Rename variables
- [ ] Run tests ‚Üí ‚úÖ
- [ ] Commit
```
</example>

<example type="invalid">
BAD: Big Bang —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥
```
–ü–µ—Ä–µ–ø–∏—Å—ã–≤–∞—é –≤–µ—Å—å –º–æ–¥—É–ª—å –∑–∞–Ω–æ–≤–æ...
```
–ü—Ä–æ–±–ª–µ–º–∞: –ù–µ—Ç –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤, –≤—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫ —Å–ª–æ–º–∞—Ç—å.
</example>

<example type="invalid">
BAD: –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –±–µ–∑ —Ç–µ—Å—Ç–æ–≤
```
–ë—ã—Å—Ç—Ä–µ–Ω—å–∫–æ –ø–æ—á–∏—â—É —ç—Ç–æ—Ç –∫–æ–¥...
```
–ü—Ä–æ–±–ª–µ–º–∞: –ë–µ–∑ —Ç–µ—Å—Ç–æ–≤ –Ω–µ—Ç –≥–∞—Ä–∞–Ω—Ç–∏–∏ —á—Ç–æ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å.
</example>

---

## Critical Points

<critical>
  ### Golden Rules:
  1. TESTS FIRST ‚Äî –Ω–µ—Ç —Ç–µ—Å—Ç–æ–≤, –Ω–µ—Ç —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞
  2. RULES FIRST ‚Äî –∫—Ä–∏—Ç–∏—á–Ω–æ–µ —Å–æ–±–ª—é–¥–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ —Ä–∞–∑–º–µ—Ä—É —Ñ–∞–π–ª–∞ –ø–µ—Ä–µ–¥ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–æ–º .cursor/rules/standard-file-size-limits-always.mdc
  2. SMALL STEPS ‚Äî –æ–¥–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∑–∞ —Ä–∞–∑
  3. TEST OFTEN ‚Äî –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è
  4. COMMIT OFTEN ‚Äî –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –∑–µ–ª—ë–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞
  5. BEHAVIOR UNCHANGED ‚Äî same inputs ‚Üí same outputs
</critical>

### Anti-patterns

- ‚ùå Big Bang: –ø–µ—Ä–µ–ø–∏—Å–∞—Ç—å –≤–µ—Å—å –º–æ–¥—É–ª—å –∑–∞ —Ä–∞–∑
- ‚ùå No Tests: —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –±–µ–∑ –ø–æ–∫—Ä—ã—Ç–∏—è —Ç–µ—Å—Ç–∞–º–∏
- ‚ùå Mixed Changes: "–ø–æ–∫–∞ —è —Ç—É—Ç, –∏—Å–ø—Ä–∞–≤–ª—é –µ—â—ë –±–∞–≥"
- ‚ùå Premature Abstraction: –∞–±—Å—Ç—Ä–∞–∫—Ü–∏—è –¥–ª—è –∫–æ–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–≥–æ 1 —Ä–∞–∑

---

**–í–µ—Ä—Å–∏—è:** 1.2
**–°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏:** `_base-confidence.mdc`, `standard-qa.mdc`, `standard-tdd.mdc`
